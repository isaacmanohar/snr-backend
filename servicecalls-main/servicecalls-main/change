<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Snap 2 Resolve - Report Issue</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    #map { height: 300px; }
    .form-section { margin-bottom: 1.5rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">Report a Civic Issue</h2>
    <form id="reportForm">
      <div class="form-section">
        <label for="description" class="form-label">Issue Description</label>
        <textarea class="form-control" id="description" rows="3" required></textarea>
      </div>

      <div class="form-section">
        <label for="image" class="form-label">Upload Photo</label>
        <input type="file" class="form-control" id="image" accept="image/*" required />
      </div>

      <div class="form-section">
        <label class="form-label">Select Location on Map</label>
        <div id="map"></div>
        <input type="hidden" id="latitude" name="latitude" />
        <input type="hidden" id="longitude" name="longitude" />
      </div>

      <button type="submit" class="btn btn-primary">Submit Report</button>
    </form>

    <div id="status" class="mt-3"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script>
    // Leaflet Map Setup
    const map = L.map('map').setView([17.385044, 78.486671], 13); // Default: Hyderabad
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker;

    map.on('click', function (e) {
      const { lat, lng } = e.latlng;
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lng;

      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
    });

    // Form Submission
    document.getElementById('reportForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const desc = document.getElementById('description').value;
      const imageFile = document.getElementById('image').files[0];
      const lat = document.getElementById('latitude').value;
      const lng = document.getElementById('longitude').value;

      if (!imageFile || !lat || !lng) {
        document.getElementById('status').innerText = 'Please complete all fields.';
        return;
      }

      // Upload image to Cloudinary
      const formData = new FormData();
      formData.append('file', imageFile);
      formData.append('upload_preset', 'ml_default'); // Default unsigned preset
      formData.append('cloud_name', 'dndlmtrgx');

      const res = await fetch('https://api.cloudinary.com/v1_1/dndlmtrgx/image/upload', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();
      const imageUrl = data.secure_url;

      // Send to Flask server
      const result = await fetch('/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          description: desc,
          image_url: imageUrl,
          latitude: lat,
          longitude: lng
        })
      });

      const serverResponse = await result.json();
      document.getElementById('status').innerText = serverResponse.message;
    });
  </script>
</body>
</html>
